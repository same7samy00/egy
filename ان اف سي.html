<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>قارئ كروت NFC</title>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #3a7bd5;
            --secondary-color: #374151;
            --accent-color: #f0f4f8;
            --border-color: #e5e7eb;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }
        * {
            font-family: 'Cairo', sans-serif;
            box-sizing: border-box;
        }
        body {
            background-color: var(--accent-color);
            margin: 0; padding: 0; direction: rtl;
        }

        /* === Top Bar Styles === */
        .top-bar {
            background: linear-gradient(135deg, #3a7bd5, #2e5faa);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            height: 60px; padding: 0 1rem; display: flex; align-items: center;
            justify-content: space-between; color: white; position: sticky; top: 0; z-index: 900;
        }
        .icon-container {
            background-color: rgba(255, 255, 255, 0.15); border-radius: 8px;
            width: 40px; height: 40px; cursor: pointer; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center;
            color: white !important; text-decoration: none; flex-shrink: 0;
        }
        .icon-container:hover {
            background-color: rgba(255, 255, 255, 0.25); transform: scale(1.05);
        }
        .top-bar-title {
            font-weight: 700; flex-grow: 1; text-align: center;
        }
        
        /* === Content Styles === */
        .content-wrapper {
             padding: 1rem; max-width: 700px; margin: 2rem auto;
        }
        .card {
            background-color: white; padding: 2rem; border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center;
        }
        .main-icon-wrapper {
            font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;
            position: relative; display: inline-block;
        }
        .main-icon-wrapper.pulsing::before {
            content: '';
            position: absolute; top: 50%; left: 50%; width: 100%; height: 100%;
            border-radius: 50%; background-color: var(--primary-color);
            transform: translate(-50%, -50%); animation: pulse 1.5s infinite; z-index: -1;
        }
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(0.9); opacity: 0.7; }
            70% { transform: translate(-50%, -50%) scale(1.4); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(0.9); opacity: 0; }
        }
        .card-title {
            font-size: 1.5rem; font-weight: 700; color: var(--secondary-color); margin-bottom: 0.5rem;
        }
        .card-description {
            color: #6b7280; margin-bottom: 1.5rem; line-height: 1.6;
        }
        .btn {
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 700;
            cursor: pointer; transition: all 0.2s ease; border: none; font-size: 1.1rem;
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #2e5faa; }
        .btn-primary:disabled { background-color: #93c5fd; cursor: not-allowed; }
        .btn-secondary { background-color: #e5e7eb; color: var(--secondary-color); font-size: 0.9rem; padding: 0.5rem 1rem; }

        /* Status & Results */
        .status-area {
            margin-top: 1.5rem; padding: 0.75rem; border-radius: 0.5rem;
            font-weight: 600; transition: background-color 0.3s;
        }
        .status-info { background-color: #e0f2fe; color: #0c4a6e; }
        .status-success { background-color: #dcfce7; color: #166534; }
        .status-error { background-color: #fee2e2; color: #991b1b; }
        
        .results-area { margin-top: 1.5rem; text-align: right; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .results-area h3 { font-weight: 700; }
        #recordsContainer .record-entry {
             background-color: #f9fafb; padding: 1rem; border: 1px solid var(--border-color); border-radius: 0.5rem; margin-bottom: 0.75rem;
        }
        #recordsContainer pre {
            white-space: pre-wrap; word-wrap: break-word; font-family: monospace;
            direction: ltr; text-align: left; background-color: #e5e7eb; padding: 0.75rem;
            border-radius: 0.5rem; font-size: 0.9rem;
        }
        .compatibility-notice {
            background-color: #fffbeb; color: #b45309; padding: 1rem;
            border: 1px solid #fde047; border-radius: 0.5rem; margin-top: 1.5rem;
        }
    </style>
</head>
<body>
    
    <div class="top-bar">
        <a href="#" onclick="history.back(); return false;" class="icon-container"><i class="fas fa-arrow-right"></i></a>
        <div class="top-bar-title">قارئ NFC</div>
        <div class="icon-container" id="notificationIcon"><i class="fas fa-bell"></i></div>
    </div>

    <div class="content-wrapper">
        <div class="card">
            <div class="main-icon-wrapper" id="mainIconWrapper"><i class="fas fa-wifi"></i></div>
            <h2 class="card-title">قراءة بيانات كروت NFC</h2>
            <p class="card-description">هذه الميزة تتطلب تطبيق أندرويد بصلاحيات NFC مفعلة.</p>
            
            <div id="nfc-ui">
                <button id="scanButton" class="btn btn-primary">
                    <i class="fas fa-satellite-dish"></i>
                    <span id="scanButtonText">ابدأ المسح</span>
                </button>
                <div id="statusArea" class="status-area status-info">اضغط على الزر لبدء عملية المسح</div>
            </div>
            
            <div id="compatibilityNotice" class="compatibility-notice" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <b>ميزة غير مدعومة:</b> متصفحك أو جهازك لا يدعم تقنية Web NFC.
            </div>

            <div id="resultsArea" style="display: none;">
                 <div class="results-header">
                    <h3>سجل القراءات</h3>
                    <button id="clearLogButton" class="btn btn-secondary"><i class="fas fa-trash-alt"></i> مسح</button>
                 </div>
                <div id="recordsContainer"></div>
            </div>
        </div>
    </div>
    
    <div id="notificationModal" style="display:none;"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const scanButton = document.getElementById('scanButton');
            const scanButtonText = document.getElementById('scanButtonText');
            const statusArea = document.getElementById('statusArea');
            const resultsArea = document.getElementById('resultsArea');
            const recordsContainer = document.getElementById('recordsContainer');
            const nfcUi = document.getElementById('nfc-ui');
            const compatibilityNotice = document.getElementById('compatibilityNotice');
            const mainIconWrapper = document.getElementById('mainIconWrapper');
            const clearLogButton = document.getElementById('clearLogButton');
            
            if (!('NDEFReader' in window)) {
                nfcUi.style.display = 'none';
                compatibilityNotice.style.display = 'block';
                return;
            }

            scanButton.addEventListener('click', async () => {
                updateUIState('scanning', 'قرّب الكارت من هاتفك الآن...');
                try {
                    const ndef = new NDEFReader();
                    await ndef.scan();
                    
                    ndef.addEventListener('readingerror', () => {
                        updateUIState('error', 'فشل قراءة الكارت. حاول مرة أخرى.');
                    });

                    ndef.addEventListener('reading', ({ message }) => {
                        updateUIState('success', `تمت قراءة ${message.records.length} سجل بنجاح!`);
                        displayScanResults(message);
                    });

                } catch (error) {
                    let errorMessage = `فشل بدء المسح: ${error.name}`;
                    if (error.name === 'NotAllowedError') {
                        errorMessage = 'تم رفض الإذن من التطبيق أو المتصفح. تأكد من تفعيل الصلاحيات.';
                    }
                    updateUIState('error', errorMessage);
                    console.error(`خطأ بدء المسح:`, error);
                }
            });
            
            function displayScanResults(message) {
                resultsArea.style.display = 'block';
                clearLogButton.style.display = 'inline-flex';
                const resultEntry = document.createElement('div');
                resultEntry.className = 'record-entry';
                let entryContent = `<h4>قراءة جديدة (${new Date().toLocaleTimeString()})</h4>`;
                if (message.records.length > 0) {
                    for (const record of message.records) {
                        entryContent += '<hr style="margin: 0.5rem 0;">';
                        let content = '';
                        if (record.recordType === "text") {
                            const textDecoder = new TextDecoder(record.encoding);
                            content = `<b>نص:</b> ${textDecoder.decode(record.data)}`;
                        } else if (record.recordType === "url") {
                             const textDecoder = new TextDecoder();
                             content = `<b>رابط:</b> <a href="${textDecoder.decode(record.data)}" target="_blank" style="color: var(--primary-color);">${textDecoder.decode(record.data)}</a>`;
                        } else {
                            const hex = [...new Uint8Array(record.data)].map(b => b.toString(16).padStart(2, '0')).join(' ');
                            content = `<b>نوع: ${record.recordType}</b><br><pre>${hex}</pre>`;
                        }
                        entryContent += `<div>${content}</div>`;
                    }
                } else {
                    entryContent += '<p>الكارت فارغ.</p>';
                }
                resultEntry.innerHTML = entryContent;
                recordsContainer.prepend(resultEntry);
            }

            function updateUIState(state, message) {
                scanButton.disabled = state === 'scanning';
                scanButtonText.textContent = state === 'scanning' ? 'جاري المسح...' : 'ابدأ المسح';
                mainIconWrapper.classList.toggle('pulsing', state === 'scanning');
                statusArea.textContent = message;
                statusArea.className = `status-area status-${state}`;
            }

            clearLogButton.addEventListener('click', () => {
                recordsContainer.innerHTML = '';
                resultsArea.style.display = 'none';
                clearLogButton.style.display = 'none';
                updateUIState('info', 'اضغط على الزر لبدء عملية المسح');
            });
        });
    </script>
</body>
</html>
